<head>
  <meta charset=utf-8 />
  <title>Test</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

  <!-- Load Leaflet from CDN-->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>

  <!-- Load Esri Leaflet from CDN -->
  <script src="https://unpkg.com/esri-leaflet@2.0.7"></script>

  <script src="https://d3js.org/d3.v3.min.js"></script>

  <script>
    access_token = window.location.search.match(/^\?token=(.*)$/);
    access_token = (access_token && access_token.length > 1 && access_token[1]);

    geURL = 'https://geoenrich.arcgis.com/arcgis/rest/services/World/geoenrichmentserver/Geoenrichment';
    reverseGeocodeURL = 'https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/reverseGeocode';
    enrichURL = geURL + '/enrich';
  </script>

  <script src="agolHelper.js"></script>

  <style>
    body { margin:0; padding:0; }
    #map { position: absolute; top:0; bottom:0; right:0; left:0; }
    .leaflet-div-icon {
        /*background: rgba(255, 255, 255, 0);*/
        border: none;
        background: none;
    }

    /* The Overlay (background) */
    .overlay {
      /* Height & width depends on how you want to reveal the overlay (see JS below) */
      height: 0%;
      width: 100%;
      position: fixed; /* Stay in place */
      z-index: 9999; /* Sit on top */
      left: 0;
      top: 0;
      background-color: rgb(0,0,0); /* Black fallback color */
      background-color: rgba(0,0,0, 0.3); /* Black w/opacity */
      overflow-x: hidden; /* Disable horizontal scroll */
    }

    /* Position the content inside the overlay */
    /*.overlay-content {
      position: relative;
      top: 25%;
      width: 100%;
      text-align: center;
      margin-top: 30px;
    }*/

    /* The navigation links inside the overlay */
    .overlay a {
      /* padding: 8px; */
      text-decoration: none;
      font-size: 36px;
      color: #DEDEDE;
      /*display: block; Display block instead of inline */
    }

    /* Position the close button (top right corner) */
    .overlay .closebtn {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 20px;
    }
  </style>
</head>
<body>

<div id="map"></div>

<!-- The overlay -->
<div id="sunburstChart" class="overlay">

  <!-- Button to close the overlay navigation -->
  <a href="javascript:void(0)" class="closebtn" onclick="closeSunburstChart()">&times;</a>

  <form>
    <label><input type="radio" name="mode" value="size"> Size</label>
    <label><input type="radio" name="mode" value="count" checked> Count</label>
  </form>

</div>

<script>
$( function() {

  var map = L.map('map').setView([45.526, -122.667], 12);
  L.esri.basemapLayer('Streets').addTo(map);

  var locationsLayer = L.featureGroup();
  map.addLayer(locationsLayer);

  var buffersLayer = L.featureGroup();
  map.addLayer(buffersLayer);

  map.on('click', onMapClick);

  function onMapClick(e) {
    reverseGeocodeLocation(e.latlng).then(
      function (gRes) {
        var marker = L.marker(gRes.latlng);
        marker.address = gRes.address;

        enrichLocation(gRes.location).then(
          function (eRes) {
            var style = {
              lineCap: "butt",
              lineJoin: "miter",
              fill: true,
              weight: 2,
              color: "rgb(51,136,255)",
              opacity: 1,
              fillColor: "rgb(51,136,255)",
              fillOpacity: 0.2
            };

            var layer = L.GeoJSON.geometryToLayer(eRes.geojsonFeature, style);
            buffersLayer.addLayer(layer);

            marker.areaFeature = eRes.geojsonFeature;
          },
          function (err) {
            console.log(err);
          }
        );

        locationsLayer.addLayer(marker);

        var openChartLink =
          $('<a>')
          .attr('id', 'xxx')
          .attr('href', 'javascript:void(0)')
          .addClass('openChartLink')
          .html("Spending Sunburst");

        var popup =
          $('<div>')
          .append(gRes.address)
          .append($('<br>'))
          .append(openChartLink)
          .on('click', '.openChartLink', function(e){
            openSunburstChart(marker);
          });

        marker.bindPopup(popup[0]).openPopup();
      },
      function (err) {
        console.log(err);
      }
    );
  }
} );

function openSunburstChart(marker) {
  $('#sunburstChart').css('height', '100%');

  var width = 960,
      height = 700,
      radius = Math.min(width, height) / 2,
      color = d3.scale.category20c();

  var svg = d3.select("#sunburstChart")
    .append("svg")
      .attr("width", width)
      .attr("height", height)
    .append("g")
      .attr("transform", "translate(" + width / 2 + "," + height * .52 + ")");

  var partition = d3.layout.partition()
      .sort(null)
      .size([2 * Math.PI, radius * radius])
      .value(function(d) { return 1; });

  var arc = d3.svg.arc()
      .startAngle(function(d) { return d.x; })
      .endAngle(function(d) { return d.x + d.dx; })
      .innerRadius(function(d) { return Math.sqrt(d.y); })
      .outerRadius(function(d) { return Math.sqrt(d.y + d.dy); });

  // Stash the old values for transition.
  function stash(d) {
    d.x0 = d.x;
    d.dx0 = d.dx;
  }

  // Interpolate the arcs in data space.
  function arcTween(a) {
    var i = d3.interpolate({x: a.x0, dx: a.dx0}, a);
    return function(t) {
      var b = i(t);
      a.x0 = b.x;
      a.dx0 = b.dx;
      return arc(b);
    };
  }

  //var jsonUrl = "https://dmit8914.github.io/sunburst/flare.json";
  var jsonUrl = "https://dmit8914.github.io/food.json";
  d3.json(jsonUrl, function(error, root) {
    if (error) throw error;

    var path = svg.datum(root).selectAll("path")
        .data(partition.nodes)
      .enter().append("path")
        .attr("display", function(d) { return d.depth ? null : "none"; }) // hide inner ring
        .attr("d", arc)
        .style("stroke", "#fff")
        .style("fill", function(d) { return color(d.name); })
        .style("fill-rule", "evenodd")
        .each(stash);

    d3.selectAll("input").on("change", function change() {
      var value = this.value === "count"
          ? function() { return 1; }
          : function(d) { return marker.areaFeature.properties[d.name]; };

      path
          .data(partition.value(value).nodes)
        .transition()
          .duration(1500)
          .attrTween("d", arcTween);
    });
  });
}

function openClickableSunburstChart(marker) {
  $('#sunburstChart').css('height', '100%');

  var width = 960,
      height = 700,
      radius = Math.min(width, height) / 2;

  var x = d3.scale.linear()
      .range([0, 2 * Math.PI]);

  var y = d3.scale.sqrt()
      .range([0, radius]);

  var color = d3.scale.category20c();

  var svg = d3.select("#sunburstChart").append("svg")
      .attr("width", width)
      .attr("height", height)
    .append("g")
      .attr("transform", "translate(" + width / 2 + "," + (height / 2 + 10) + ")");

  var partition = d3.layout.partition()
      .sort(null)
      .value(function(d) { return 1; });

  var arc = d3.svg.arc()
      .startAngle(function(d) { return Math.max(0, Math.min(2 * Math.PI, x(d.x))); })
      .endAngle(function(d) { return Math.max(0, Math.min(2 * Math.PI, x(d.x + d.dx))); })
      .innerRadius(function(d) { return Math.max(0, y(d.y)); })
      .outerRadius(function(d) { return Math.max(0, y(d.y + d.dy)); });

  // Keep track of the node that is currently being displayed as the root.
  var node;

  //var jsonUrl = "https://dmit8914.github.io/sunburst/flare.json";
  var jsonUrl = "https://dmit8914.github.io/food.json";
  d3.json(jsonUrl, function(error, root) {
    node = root;
    var path = svg.datum(root).selectAll("path")
        .data(partition.nodes)
      .enter().append("path")
        .attr("d", arc)
        //.style("stroke", "#fff")
        .style("fill", function(d) { return color(d.name); })
        .style("fill-rule", "evenodd")
        .on("click", click)
        .each(stash);

    d3.selectAll("input").on("change", function change() {
      var value = this.value === "count"
          ? function() { return 1; }
          : function(d) { return marker.areaFeature.properties[d.name]; };

      path
          .data(partition.value(value).nodes)
        .transition()
          .duration(1000)
          .attrTween("d", arcTweenData);
    });

    function click(d) {
      node = d;
      path.transition()
        .duration(1000)
        .attrTween("d", arcTweenZoom(d));
    }
  });

  // Setup for switching data: stash the old values for transition.
  function stash(d) {
    d.x0 = d.x;
    d.dx0 = d.dx;
  }

  // When switching data: interpolate the arcs in data space.
  function arcTweenData(a, i) {
    var oi = d3.interpolate({x: a.x0, dx: a.dx0}, a);
    function tween(t) {
      var b = oi(t);
      a.x0 = b.x;
      a.dx0 = b.dx;
      return arc(b);
    }
    if (i == 0) {
     // If we are on the first arc, adjust the x domain to match the root node
     // at the current zoom level. (We only need to do this once.)
      var xd = d3.interpolate(x.domain(), [node.x, node.x + node.dx]);
      return function(t) {
        x.domain(xd(t));
        return tween(t);
      };
    } else {
      return tween;
    }
  }

  // When zooming: interpolate the scales.
  function arcTweenZoom(d) {
    var xd = d3.interpolate(x.domain(), [d.x, d.x + d.dx]),
        yd = d3.interpolate(y.domain(), [d.y, 1]),
        yr = d3.interpolate(y.range(), [d.y ? 20 : 0, radius]);
    return function(d, i) {
      return i
          ? function(t) { return arc(d); }
          : function(t) { x.domain(xd(t)); y.domain(yd(t)).range(yr(t)); return arc(d); };
    };
  }

}

function closeSunburstChart() {
  $('#sunburstChart').css('height', '0%');
}

</script>

</body>
