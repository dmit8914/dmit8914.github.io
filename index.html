<head>
  <meta charset=utf-8 />
  <title>Test</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

  <!-- Load Leaflet from CDN-->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>

  <!-- Load Esri Leaflet from CDN -->
  <script src="https://unpkg.com/esri-leaflet@2.0.7"></script>

  <script>
    access_token = window.location.search.match(/^\?token=(.*)$/);
    access_token = (access_token && access_token.length > 1 && access_token[1]);

    geURL = 'https://geoenrich.arcgis.com/arcgis/rest/services/World/geoenrichmentserver/Geoenrichment';
    reverseGeocodeURL = 'https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/reverseGeocode';
    enrichURL = geURL + '/enrich';
  </script>

  <script src="agolHelper.js"></script>

  <style>
    body { margin:0; padding:0; }
    #map { position: absolute; top:0; bottom:0; right:0; left:0; }
    .leaflet-div-icon {
        /*background: rgba(255, 255, 255, 0);*/
        border: none;
        background: none;
    }
  </style>
</head>
<body>

<div id="map"></div>

<script>
$( function() {

  var map = L.map('map').setView([45.526, -122.667], 12);
  L.esri.basemapLayer('Streets').addTo(map);

  var locationsLayer = L.featureGroup();
  map.addLayer(locationsLayer);

  var buffersLayer = L.featureGroup();
  map.addLayer(buffersLayer);

  map.on('click', onMapClick);

  function onMapClick(e) {
    reverseGeocodeLocation(e.latlng).then(
      function (gRes) {
        var marker = L.marker(gRes.latlng);
        marker.address = gRes.address;

        enrichLocation(gRes.location).then(
          function (eRes) {
            var style = {
              lineCap: "butt",
              lineJoin: "miter",
              fill: true,
              weight: 2,
              color: "rgb(51,136,255)",
              opacity: 1,
              fillColor: "rgb(51,136,255)",
              fillOpacity: 0.2
            };

            var layer = L.GeoJSON.geometryToLayer(eRes.geojsonFeature, style);
            buffersLayer.addLayer(layer);

            marker.areaFeature = eRes.geojsonFeature;
          },
          function (err) {
            console.log(err);
          }
        );

        locationsLayer.addLayer(marker);

        var openChartLink =
          $('<a>')
          .attr('id', 'xxx')
          .attr('href', '#')
          .addClass('openChartLink')
          .html("Spending Sunburst");

        var popup =
          $('<div>')
          .append(gRes.address)
          .append($('<br>'))
          .append(openChartLink)
          .on('click', '.openChartLink', function(e){
            console.log(marker.address);
          });

        marker.bindPopup(popup[0]).openPopup();
      },
      function (err) {
        console.log(err);
      }
    );
  }
} );
</script>

</body>
